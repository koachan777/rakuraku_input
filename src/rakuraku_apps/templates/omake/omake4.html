{% load static %} {% block PageCss %} 
<link href="{% static '/css/button.css' %}"
	rel="stylesheet">
<link href="{% static '/css/omake1.css' %}"
	rel="stylesheet">{% endblock %} {% block PageJs %} 
<script src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
<script type="text/javascript" src="{% static 'js/omake1.js' %}"></script>{% endblock %} {% block content %} {% if user.is_authenticated %} 

    <meta charset="UTF-8" />
        <style>
            h1{
                text-align:center;
            }
            canvas {
                background: #eee;
                }
            #canvas-wrapper{
                max-width:900px;
                margin:0 auto;
            }
            .canvas-responsive{
                /* width:480px;
                margin:0 auto; */
                width:100%;
            }

            .button {
                display: none;
                vertical-align: middle;
                text-align:center;
                margin:32px;
            }

            .button div {
                display: inline-block;
                border-radius: 50%;
            }

            .button div:hover .left{
                border: 0.5em solid #e74c3c;
            }
            .button div:hover .right{
                border: 0.5em solid #e74c3c;
            }
            .button div:hover .left:after{
                border-top: 0.5em solid #e74c3c;
                border-right: 0.5em solid #e74c3c;
            }
            .button div:hover .right:after {
                border-top: 0.5em solid #e74c3c;
                border-right: 0.5em solid #e74c3c;
            }

            .left {
                display: inline-block;
                width: 4em;
                height: 4em;
                border: 0.5em solid #333;
                border-radius: 50%;
                margin-right: 1.5em;
            }

            .left:after {
                content: '';
                display: inline-block;
                margin-top: 1.05em;
                margin-left: 0.6em;
                width: 1.4em;
                height: 1.4em;
                border-top: 0.5em solid #333;
                border-right: 0.5em solid #333;
                -moz-transform: rotate(-135deg);
                -webkit-transform: rotate(-135deg);
                transform: rotate(-135deg);
            }

            .right {
                display: inline-block;
                width: 4em;
                height: 4em;
                border: 0.5em solid #333;
                border-radius: 50%;
                margin-left: 1.5em;
            }

            .right:after {
                content: '';
                display: inline-block;
                margin-top: 1.05em;
                margin-left: -0.6em;
                width: 1.4em;
                height: 1.4em;
                border-top: 0.5em solid #333;
                border-right: 0.5em solid #333;
                -moz-transform: rotate(45deg);
                -webkit-transform: rotate(45deg);
                transform: rotate(45deg);
            }
            @media (max-width:1000px){
                .button {
                    display: inline-block;
                    vertical-align: middle;
                    text-align:center;
                    margin:32px;
                }
            }
        </style>
        <script type="text/javascript" src="https://pythonchannel.com/static/js/jquery.min.js"></script>
    </head>
<body>
    <h1>ピンポンゲーム</h1>
    <div id="canvas-wrapper">
    <canvas id="myCanvas" class="canvas-responsive"></canvas>
        <div id="leftButton" class="button" style="float:left">
            <div>
                <span class="left"></span>
            </div>
        </div>

        <div id="rightButton" class="button" style="float:right">
            <div>
                <span class="right"></span>
            </div>
        </div>
    </div>

    <script>
        // canvas のレスポンシブ処理
        function resize(){    
          $(".canvas-responsive").outerHeight($(window).height()*2/3 -$(".canvas-responsive").offset().top- Math.abs($(".canvas-responsive").outerHeight(true) - $(".canvas-responsive").outerHeight()));
        }
        $(document).ready(function(){
          resize();
          $(window).on("resize", function(){                      
              resize();
          });
        });
        //outerHeight() 高さ取得、 .offset()  位置、　Math.abs() 絶対値、　

        var canvas = document.getElementById("myCanvas");
        var ctx = canvas.getContext("2d");
        var ballRadius = 5;
        var x = canvas.width/2;
        var y = canvas.height-30;
        var dx = 2;
        var dy = -2;
        var paddleHeight = 10;
        var paddleWidth = 75;
        var paddleX = (canvas.width-paddleWidth)/2;
        var rightPressed = false;
        var leftPressed = false;
        var brickRowCount = 8;
        var brickColumnCount = 3;
        var brickWidth = 26;
        var brickHeight = 10;
        var brickPadding = 10;
        var brickOffsetTop = 25;
        var brickOffsetLeft = 10;
        var score = 0;

        var bricks = [];
        for(var c=0; c<brickColumnCount; c++) {
          bricks[c] = [];
          for(var r=0; r<brickRowCount; r++) {
            bricks[c][r] = { x: 0, y: 0, status: 1 };
          }
        }


        // スマホ用　右左のボタン
        //var canvas = document.getElementById("myCanvas");
        //var ctx = canvas.getContext("2d");
        var leftButton = document.getElementById("leftButton");
        leftButton.addEventListener("touchstart", touchLeft);
        leftButton.addEventListener("touchend", touchLeft);
        function touchLeft(e){
            console.log('左はば' + canvas.width)
            console.log('左：' + e.touches, e.type);
            if(e.type == 'touchstart'){
                leftPressed = true;
            } else if(e.type == 'touchend'){
                leftPressed = false;
            }
        }
        var rightButton = document.getElementById("rightButton");
        rightButton.addEventListener("touchstart", touchRight);
        rightButton.addEventListener("touchend", touchRight);
        function touchRight(e){
            console.log('右はば' + canvas.width)
            console.log('右：' + e.touches, e.type);
            if(e.type == 'touchstart'){
                rightPressed = true;
            } else if(e.type == 'touchend'){
                rightPressed = false;
            }
        }

        // パソコン用キーボード操作
        document.addEventListener("keydown", keyDownHandler, false);
        document.addEventListener("keyup", keyUpHandler, false);

        function keyDownHandler(e) {
            if(e.key == "Right" || e.key == "ArrowRight") {
                rightPressed = true;
            }
            else if(e.key == "Left" || e.key == "ArrowLeft") {
                leftPressed = true;
            }
        }

        function keyUpHandler(e) {
            if(e.key == "Right" || e.key == "ArrowRight") {
                rightPressed = false;
            }
            else if(e.key == "Left" || e.key == "ArrowLeft") {
                leftPressed = false;
            }
        }

        function collisionDetection() {
          for(var c=0; c<brickColumnCount; c++) {
            for(var r=0; r<brickRowCount; r++) {
              var b = bricks[c][r];
              if(b.status == 1) {
                if(x > b.x && x < b.x+brickWidth && y > b.y && y < b.y+brickHeight) {
                  dy = -dy;
                  b.status = 0;
                  score++;
                  if(score == brickRowCount*brickColumnCount) {
                    alert("やったね！");
                    document.location.reload();
                    clearInterval(interval); // ゲーム再スタート
                  }
                }
              }
            }
          }
        }

        function drawBall() {
          ctx.beginPath();
          ctx.arc(x, y, ballRadius, 0, Math.PI*2);
          ctx.fillStyle = "red";
          ctx.fill();
          ctx.closePath();
        }
        function drawPaddle() {
          ctx.beginPath();
          ctx.rect(paddleX, canvas.height-paddleHeight, paddleWidth, paddleHeight);
          ctx.fillStyle = "blue";
          ctx.fill();
          ctx.closePath();
        }
        function drawBricks() {
          for(var c=0; c<brickColumnCount; c++) {
            for(var r=0; r<brickRowCount; r++) {
              if(bricks[c][r].status == 1) {
                var brickX = (r*(brickWidth+brickPadding))+brickOffsetLeft;
                var brickY = (c*(brickHeight+brickPadding))+brickOffsetTop;
                bricks[c][r].x = brickX;
                bricks[c][r].y = brickY;
                ctx.beginPath();
                ctx.rect(brickX, brickY, brickWidth, brickHeight);
                ctx.fillStyle = "black";
                ctx.fill();
                ctx.closePath();
              }
            }
          }
        }
        function drawScore() {
          ctx.font = "16px Arial";
          ctx.fillStyle = "blue";
          ctx.fillText("点数： "+score, 8, 20);
        }

        function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawBricks();
          drawBall();
          drawPaddle();
          drawScore();
          collisionDetection();

          if(x + dx > canvas.width-ballRadius || x + dx < ballRadius) {
            dx = -dx;
          }
          console.log('y値:' + y + dy);
          if(y + dy < ballRadius) {
            dy = -dy;
          }
          else if(y + dy > canvas.height-ballRadius) {
            if(x > paddleX && x < paddleX + paddleWidth) {
              dy = -dy;
            }
            else {
              alert("まけ");
              document.location.reload();
              clearInterval(interval);
            }
          }

          if(rightPressed && paddleX < canvas.width-paddleWidth) {
            paddleX += 7;
          }
          else if(leftPressed && paddleX > 0) {
            paddleX -= 7;
          }

          x += dx;
          y += dy;
        }
        var interval = setInterval(draw, 20);
    </script>

{% include 'footer.html' %} {% else %} 
<div class="text-center mt-5">
	<p>データ入力機能を使用するにはログインが必要です。
	</p>
	<a href="{% url 'rakuraku_apps:login' %}"
		class="btn btn-primary">ログイン
	</a>
</div>{% endif %} {% endblock %}